<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>q_tut Vue Blob Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="/qrpc/qrpc/static/qrpc_vue_plugin.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 32px;
            background-color: #fafafa;
            color: #222;
        }
        #app {
            max-width: 640px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
        }
        input[type="number"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            margin-top: 12px;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        button[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .blob-card {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            background-color: #fdfdfd;
        }
        .blob-preview {
            white-space: pre-wrap;
            background: #f6f8fa;
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
        }
        .status {
            margin-top: 12px;
            font-style: italic;
        }
        .error {
            color: #b00020;
            font-weight: 600;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Blob Response Demo</h1>
        <p>This example calls <code>q_tut:hello_blob/1</code> and renders multipart blobs using the QRPC Vue plugin.</p>

        <label for="blob-count-input">Blob count</label>
        <input id="blob-count-input" type="number" min="1" max="10" v-model.number="blobCount" />
        <button :disabled="loading" @click="fetchBlobs">
            {{ loading ? 'Loading…' : 'Fetch blobs' }}
        </button>

        <div class="status" v-if="loading">Requesting blobs…</div>
        <div class="error" v-if="errorMessage">{{ errorMessage }}</div>

        <section v-if="payload">
            <h2>Payload</h2>
            <pre class="blob-preview">{{ payload }}</pre>
        </section>

        <section v-if="blobs.length">
            <h2>Blobs</h2>
            <div class="blob-card" v-for="blob in blobs" :key="blob.index">
                <div><strong>Blob {{ blob.index + 1 }}</strong> · {{ blob.contentType }} · {{ blob.sizeLabel }}</div>
                <div class="blob-preview">{{ blob.preview }}</div>
                <button @click="downloadBlob(blob)">Download</button>
            </div>
        </section>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    blobCount: 2,
                    loading: false,
                    errorMessage: '',
                    payload: null,
                    blobs: []
                };
            },
            methods: {
                formatError(error) {
                    const languageSetting = this.$qrpc?.settings?.get()?.language || 'en';
                    return (error?.messages && error.messages[languageSetting])
                        || error?.metadata?.error_detail?.message
                        || error?.message
                        || 'Unknown error.';
                },
                async fetchBlobs() {
                    if (!this.$qrpc) {
                        this.errorMessage = 'QRPC plugin unavailable.';
                        return;
                    }
                    this.loading = true;
                    this.errorMessage = '';
                    this.payload = null;
                    this.blobs = [];
                    try {
                        const result = await this.$qrpc.callRpc({
                            module: 'q_tut',
                            function: 'hello_blob',
                            arity: 1,
                            payload: { blob_count: Math.max(1, this.blobCount || 1) }
                        });
                        this.payload = JSON.stringify(result?.payload ?? null, null, 2);
                        const descriptors = result?.blob || [];
                        this.blobs = await Promise.all(descriptors.map(async (descriptor, index) => {
                            let preview = '';
                            try {
                                preview = await descriptor.asText();
                            } catch (_) {
                                preview = '[binary data]';
                            }
                            const shortPreview = preview.length > 120
                                ? `${preview.slice(0, 120)}…`
                                : preview;
                            const size = descriptor.blob?.size || descriptor.contentLength || descriptor.size || 0;
                            return {
                                index,
                                descriptor,
                                contentType: descriptor.contentType,
                                sizeLabel: `${size} bytes`,
                                preview: shortPreview || '(empty)'
                            };
                        }));
                    } catch (error) {
                        this.errorMessage = `Error: ${this.formatError(error)}`;
                    } finally {
                        this.loading = false;
                    }
                },
                downloadBlob(entry) {
                    const url = entry?.descriptor?.toObjectUrl?.();
                    if (!url) {
                        this.errorMessage = 'Unable to generate a download link for this blob.';
                        return;
                    }
                    const anchor = document.createElement('a');
                    anchor.href = url;
                    anchor.download = `qrpc-blob-${entry.index + 1}.bin`;
                    anchor.style.display = 'none';
                    document.body.appendChild(anchor);
                    anchor.click();
                    setTimeout(() => {
                        document.body.removeChild(anchor);
                        entry?.descriptor?.revokeObjectUrl?.(url);
                    }, 0);
                }
            },
            mounted() {
                this.fetchBlobs();
            }
        }).use(QrpcVuePlugin).mount('#app');
    </script>
</body>
</html>
