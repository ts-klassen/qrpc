getent group qrpc >/dev/null 2>&1 || groupadd -r qrpc
id -u qrpc >/dev/null 2>&1 || useradd -r -g qrpc -d /opt/qrpc/home/qrpc -s /usr/sbin/nologin -M qrpc
getent group rabbitmq >/dev/null 2>&1 || groupadd -r rabbitmq
id -u rabbitmq >/dev/null 2>&1 || useradd -r -g rabbitmq -d /opt/qrpc/home/rabbitmq -s /usr/sbin/nologin -M rabbitmq
install -d -o root -g root -m 0755 /opt/qrpc/home
install -d -o qrpc -g qrpc -m 0750 /opt/qrpc/home/qrpc
install -d -o qrpc -g qrpc -m 0770 /opt/qrpc/var/log/qrpc
install -d -o qrpc -g qrpc -m 0770 /opt/qrpc/var/log/qrpc/stdout
install -d -o qrpc -g qrpc -m 0770 /opt/qrpc/var/log/qrpc/stderr
install -d -o qrpc -g qrpc -m 0770 /opt/qrpc/var/log/dlog
install -d -o qrpc -g qrpc -m 0770 /opt/qrpc/var/dets
install -d -o root -g root -m 0755 /opt/qrpc/rel
install -d -o rabbitmq -g rabbitmq -m 0750 /opt/qrpc/home/rabbitmq
install -d -o rabbitmq -g rabbitmq -m 0770 /opt/qrpc/var/log/rabbitmq
./pkg_add -u qrpc-prod-*.tgz
cat > /opt/qrpc/pkg/etc/ca-certificates-dir.conf << EOF
ETCCERTSDIR=/opt/qrpc/pkg/etc/openssl/certs
EOF
mkdir -p /opt/qrpc/pkg/etc/openssl/certs
/opt/qrpc/pkg/sbin/update-ca-certificates
tar -xzf qrpc.tgz -C /opt/qrpc/rel
install -m0755 foreground.sh /opt/qrpc/qrpc_foreground.sh
cp system/*.service /lib/systemd/system/.
systemctl daemon-reload
systemctl enable qrpc
systemctl restart qrpc
systemctl enable rabbitmq-server
systemctl restart rabbitmq-server

cat > /opt/qrpc/ctl <<< '#!/usr/bin/bash
cd /opt/qrpc/home/qrpc
export RELX_COOKIE="$(cat /opt/qrpc/home/qrpc/.erlang.cookie)"
sudo -u qrpc /opt/qrpc/rel/bin/qrpc "$@"
'
chmod +x /opt/qrpc/ctl

echo INSTALL COMPLETE
