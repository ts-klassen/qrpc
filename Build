#!/usr/bin/bash

set -euo pipefail

cd `dirname $0`

CHROOT_DIR="_root"
if [ "${IS_BUILD_SERVER:-}" = "1" ]; then
  CHROOT_DIR="/"
fi

root_path() {
  local rel="$1"
  if [ "$CHROOT_DIR" = "/" ]; then
    printf "/%s" "$rel"
  else
    printf "%s/%s" "$CHROOT_DIR" "$rel"
  fi
}

chroot_cmd() {
  if [ "$CHROOT_DIR" = "/" ]; then
    sudo "$@"
  else
    sudo chroot "$CHROOT_DIR" "$@"
  fi
}

case "$1" in
  bootstrap)
    ./Build unmount
    if [ "$CHROOT_DIR" != "/" ]; then
      sudo rm -rf "$CHROOT_DIR"
    fi
    sudo rm -rf /opt/qrpc/pkg
    sudo apt-get update --allow-releaseinfo-change
    sudo apt-get install -y debootstrap patch bindfs
    if [ "$CHROOT_DIR" != "/" ]; then
      sudo debootstrap --variant=minbase jammy "$CHROOT_DIR" http://archive.ubuntu.com/ubuntu/
      sudo chmod 700 "$CHROOT_DIR"
      sudo bash -c 'echo nameserver 8.8.8.8 >> '"$(root_path "etc/resolv.conf")"
    fi
    if [ -d "$(root_path "root/pkgsrc")/.git" ]; then
      sudo git -C "$(root_path "root/pkgsrc")" fetch --depth 1 origin
      sudo git -C "$(root_path "root/pkgsrc")" reset --hard origin/HEAD
    else
      sudo git clone --depth 1 https://github.com/NetBSD/pkgsrc.git "$(root_path "root/pkgsrc")"
    fi
    sudo patch "$(root_path "root/pkgsrc/mk/defaults/mk.conf")" < config/mk.conf.patch
    sudo bash -c 'echo >> '"$(root_path "etc/bash.bashrc")"
    sudo bash -c 'echo '"'"'export PATH=/opt/qrpc/pkg/bin:$PATH'"'"' >> '"$(root_path "etc/bash.bashrc")"
    sudo bash -c 'echo '"'"'export PATH=/opt/qrpc/pkg/sbin:$PATH'"'"' >> '"$(root_path "etc/bash.bashrc")"
    sudo bash -c 'echo '"'"'export MANPATH=/opt/qrpc/pkg/man:$MANPATH'"'"' >> '"$(root_path "etc/bash.bashrc")"
    chroot_cmd /usr/bin/apt-get update
    chroot_cmd /usr/bin/apt-get install -y gcc g++ wget
    ./Build mount
    chroot_cmd /usr/bin/bash -ilc 'cd /root/pkgsrc/bootstrap && ./bootstrap --prefix /opt/qrpc/pkg --pkgdbdir /opt/qrpc/pkg/pkgdb --sysconfdir /opt/qrpc/pkg/etc --varbase /opt/qrpc/var'
    ;;
  unmount)
    if sudo mountpoint -q _pkgsrc; then
      sudo umount _pkgsrc || sudo umount -l _pkgsrc || true
    fi
    if [ "$CHROOT_DIR" = "/" ]; then
      exit 0
    fi
    if sudo mountpoint -q "$(root_path "opt/qrpc")"; then
      sudo umount "$(root_path "opt/qrpc")" || sudo umount -l "$(root_path "opt/qrpc")" || true
    fi
    if sudo mountpoint -q "$(root_path "proc")"; then
      sudo umount "$(root_path "proc")" || sudo umount -l "$(root_path "proc")" || true
    fi
    ;;
  mount)
    if [ "$CHROOT_DIR" = "/" ]; then
      if ! sudo mountpoint -q _pkgsrc; then
        MAIN_USER=$USER;
        sudo mkdir -p "$(root_path "root/pkgsrc")"
        mkdir -p _pkgsrc
        sudo bindfs --map=root/$MAIN_USER:@root/@$MAIN_USER "$(root_path "root/pkgsrc")" _pkgsrc
      fi
      exit 0
    fi
    sudo mkdir -p "$(root_path "proc")"
    if ! sudo mountpoint -q "$(root_path "proc")"; then
      sudo mount -t proc proc "$(root_path "proc")"
    fi
    if ! sudo mountpoint -q "$(root_path "opt/qrpc")"; then
      sudo mkdir -p /opt/qrpc
      sudo mkdir -p "$(root_path "opt/qrpc")"
      sudo mount --bind /opt/qrpc "$(root_path "opt/qrpc")"
    fi
    if ! sudo mountpoint -q _pkgsrc; then
      MAIN_USER=$USER;
      sudo mkdir -p "$(root_path "root/pkgsrc")"
      mkdir -p _pkgsrc
      sudo bindfs --map=root/$MAIN_USER:@root/@$MAIN_USER "$(root_path "root/pkgsrc")" _pkgsrc
    fi
    ;;
  devel)
    ./Build mount
    rsync -a config/pkgsrc/files/ _pkgsrc/
    cd _pkgsrc
      git stash && git pull && git stash pop
    cd ..
    for patch in config/pkgsrc/patches/patch-*; do
      [ -e "$patch" ] || break
      if patch -d _pkgsrc --dry-run -R -p0 < "$patch" >/dev/null 2>&1; then
        echo "Patch ${patch} already applied, skipping"
        continue
      fi
      patch -d _pkgsrc -p0 -N < "$patch"
    done
    chroot_cmd /usr/bin/bash -ilc 'cd /root/pkgsrc/meta-pkgs/qrpc-devel && bmake update'
    ;;
  root)
    chroot_cmd /usr/bin/bash
    ;;
  clean)
    export PATH=/opt/qrpc/pkg/bin:$PATH
    rebar3 clean
    ;;
  build)
    export PATH=/opt/qrpc/pkg/bin:$PATH
    rebar3 compile
    ;;
  check)
    export PATH=/opt/qrpc/pkg/bin:$PATH
    rebar3 eunit && rebar3 ct --verbose && rebar3 cover && echo ALL_TEST_PASS
    ;;
  shell)
    export PATH=/opt/qrpc/pkg/bin:$PATH
    rebar3 shell
    ;;
  package)
    export PATH=/opt/qrpc/pkg/bin:$PATH
    rm -rf _pkgsrc/packages/qrpc-prod
    mkdir -p _pkgsrc/packages/qrpc-prod
    chroot_cmd /usr/bin/bash -ilc 'cd /root/pkgsrc/meta-pkgs/qrpc-prod && bmake update'
    chroot_cmd /opt/qrpc/pkg/bin/pkg_tarup -d /root/pkgsrc/packages/qrpc-prod -a qrpc-prod
    chroot_cmd cp -p /opt/qrpc/pkg/sbin/pkg_add /root/pkgsrc/packages/qrpc-prod/.
    rebar3 as prod tar
    prod=$(ls -t _build/prod/rel/qrpc/*.tar.gz | head -1)
    mv "$prod" _pkgsrc/packages/qrpc-prod/qrpc.tgz
    cp config/pkgrc _pkgsrc/packages/qrpc-prod/.pkgrc
    cp config/foreground.sh _pkgsrc/packages/qrpc-prod/foreground.sh
    cp -r config/system _pkgsrc/packages/qrpc-prod/system
    ./scripts/license_collector.sh gather _pkgsrc/packages/qrpc-prod qrpc.tgz
    echo '#!/bin/bash
        set -euo pipefail
        cd $(dirname $0)
        . .pkgrc
    ' > _pkgsrc/packages/qrpc-prod/install.sh
    chmod +x _pkgsrc/packages/qrpc-prod/install.sh
    name="$(basename "${prod%.tar.gz}")-$(rustc -Vv | sed -n 's/^host: //p')"
    mkdir -p _release_packages
    mv _pkgsrc/packages/qrpc-prod "_release_packages/${name}"
    cd _release_packages
    tar -zcf "${name}.tar.gz" "$name"
    rm -rf latest
    mv "$name" latest
    cd ..
    echo "_release_packages/${name}.tar.gz"
    ;;
  package-devel)
    export PATH=/opt/qrpc/pkg/bin:$PATH
    rm -rf _pkgsrc/packages/qrpc-devel
    mkdir -p _pkgsrc/packages/qrpc-devel
    chroot_cmd /usr/bin/bash -ilc 'cd /root/pkgsrc/meta-pkgs/qrpc-devel && bmake update'
    chroot_cmd /opt/qrpc/pkg/bin/pkg_tarup -d /root/pkgsrc/packages/qrpc-devel -a qrpc-devel
    chroot_cmd cp -p /opt/qrpc/pkg/sbin/pkg_add /root/pkgsrc/packages/qrpc-devel/.
    # make tar just to find out version number and collect license
    rebar3 as prod tar
    prod=$(ls -t _build/prod/rel/qrpc/*.tar.gz | head -1)
    mv "$prod" _pkgsrc/packages/qrpc-devel/qrpc.tgz
    ./scripts/license_collector.sh gather _pkgsrc/packages/qrpc-devel qrpc.tgz
    echo '#!/bin/bash
set -euo pipefail
cd $(dirname $0)
install -d -o root -g root -m 0755 /opt/qrpc
install -d -o root -g root -m 0755 /opt/qrpc/pkg
install -d -o root -g root -m 0755 /opt/qrpc/pkg/etc
./pkg_add -u qrpc-*.tgz
cat > /opt/qrpc/pkg/etc/ca-certificates-dir.conf << EOF
ETCCERTSDIR=/opt/qrpc/pkg/etc/openssl/certs
EOF
mkdir -p /opt/qrpc/pkg/etc/openssl/certs
/opt/qrpc/pkg/sbin/update-ca-certificates
echo INSTALL COMPLETE
' > _pkgsrc/packages/qrpc-devel/install.sh
    chmod +x _pkgsrc/packages/qrpc-devel/install.sh
    name="$(basename "${prod%.tar.gz}")-$(rustc -Vv | sed -n 's/^host: //p')-devel"
    mkdir -p _release_packages
    mv _pkgsrc/packages/qrpc-devel "_release_packages/${name}"
    cd _release_packages
    tar -zcf "${name}.tar.gz" "$name"
    rm -rf devel-latest
    mv "$name" devel-latest
    cd ..
    echo "_release_packages/${name}.tar.gz"
    ;;
  install)
    export PATH=/opt/qrpc/pkg/bin:$PATH
    ./Build package
    sudo _release_packages/latest/install.sh
    ;;
  release)
    export PATH=/opt/qrpc/pkg/bin:$PATH
    rebar3 as prod release
    ;;
  *)
    echo "this is a help message"
    ;;
esac
