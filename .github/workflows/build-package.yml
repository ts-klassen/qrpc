name: Build package on EC2

on:
  push:
    tags:
      - '*'

permissions:
  id-token: write
  contents: read

jobs:
  build-on-ec2:
    runs-on: ubuntu-latest
    # NOTE: This workflow only starts the EC2 build. It does not wait for or verify
    # completion, because the build can take hours and runs asynchronously on the instance.

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Capture tag
        id: tag
        run: |
          tag="${GITHUB_REF#refs/tags/}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Verify tag is on main
        id: verify
        run: |
          git fetch origin main
          if git merge-base --is-ancestor "$GITHUB_SHA" "origin/main"; then
            echo "on_main=true" >> "$GITHUB_OUTPUT"
          else
            echo "on_main=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip when tag is not on main
        if: steps.verify.outputs.on_main != 'true'
        run: echo "Tag is not reachable from main; skipping build."

      - name: Configure AWS credentials
        if: steps.verify.outputs.on_main == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Trigger EC2 build
        if: steps.verify.outputs.on_main == 'true'
        env:
          LAUNCH_TEMPLATE_ID: ${{ secrets.AWS_BUILD_LAUNCH_TEMPLATE_ID }}
          TAG: ${{ steps.tag.outputs.tag }}
          PROJECT_TAG: qrpc-build-server
        run: |
          set -euo pipefail

          expires_at="$(date -u -d '+24 hours' '+%Y-%m-%dT%H:%M:%SZ')"

          INSTANCE_ID=$(aws ec2 run-instances \
            --launch-template "LaunchTemplateId=$LAUNCH_TEMPLATE_ID" \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=$PROJECT_TAG},{Key=Project,Value=$PROJECT_TAG},{Key=GitHubRun,Value=$GITHUB_RUN_ID},{Key=Tag,Value=$TAG},{Key=ExpiresAt,Value=$expires_at}]" \
            --query "Instances[0].InstanceId" \
            --output text)

          echo "EC2 instance: $INSTANCE_ID"
          aws ec2 wait instance-running --instance-ids "$INSTANCE_ID"
          echo "Build starts automatically on the instance using its Tag/ExpiresAt tags."
